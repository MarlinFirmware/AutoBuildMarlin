<!DOCTYPE html>
<html lang="en" id="abm">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta
  http-equiv="Content-Security-Policy"
  content="default-src 'nonce-${nonce}'; font-src https://fonts.gstatic.com/; style-src ${ pv.cspSource } https://fonts.googleapis.com/; img-src ${ pv.cspSource }; script-src 'unsafe-inline' ${ pv.cspSource };"
/>
<title>Auto Build Marlin — Home</title>
<link nonce="${nonce}" href="https://fonts.googleapis.com/css?family=Fira+Mono&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css" />
<script nonce="${nonce}">
//<![CDATA[

  // Template parameters are evaluated in the context of abm.js.
  // But this script is evaluated in the context of abmview.js.

  const vscode = acquireVsCodeApi();

  // Select a tool tab in the web view (Build, Config, etc.)
  function abm_tool(tool) {
    $('.abm-tool').hide();
    $('#abm-'+tool).show();
    $('#abm-toolbar button').removeClass();
    $('#btn-'+tool).addClass('active');
  }

  // Select a pane under the Config tool
  function abm_pane(name) {
    var $t;
    if (name)
      $t = $('.subtabs button[ref=' + name + ']');
    else {
      $t = $('.subtabs button').first();
      name = $t.attr('ref');
    }
    $('.subtabs button').removeClass();
    $t.addClass('active');
    $('.abm-tool .subpanes>div').hide();
    $t.parents('.abm-tool').find('.subpanes>.' + name).show();
  }

  // Receive data about boards in a nested array, with
  // MCU category as the outer array and board name as the inner array.
  function abm_boards(data, sel="") {
    const $s1 = $('#board-family'), $s2 = $('#bid');
    $s1.empty(); $s2.empty();

    let s2_boards = [];

    // Create a selector with the family names as options.
    // Set an attribute on the option to point to the list of boards.
    // When the family selector $s1 changes, update the board selector $s2.
    for (let i = 0; i < data.length; i++) {
      var family = data[i].family,
          boards = data[i].boards,
          $opt = $('<option value="' + i + '">' + family + '</option>');

      // If we find a matching board, select the option and break the loop
      for (let j = 0; j < boards.length; j++) {
        if (boards[j].name.toLowerCase() == sel.toLowerCase()) {
          //console.log("Board match " + boards[j].name + " == " + sel);
          $opt.attr('selected', 'selected');
          s2_boards = boards;
          break;
        }
      }

      $opt[0].boards = boards;
      $s1.append($opt);
    }

    function populate_s2(boards, sel) {
      $s2.empty();
      var sel_cmp = sel.toLowerCase();
      for (var i = 0; i < boards.length; i++) {
        var board = boards[i],
            id = board.id,
            name = board.name.replace(/^BOARD_/,''),
            desc = board.desc,
            esc_desc = desc.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'),
            $opt = $('<option value="' + name + '" title="' + esc_desc + '">' + name + ' : ' + esc_desc + '</option>');
        if (board.name.toLowerCase() == sel_cmp)
          $opt.attr('selected', 'selected');
        $s2.append($opt);
      }
    }

    // If s2_boards has items add them as options to $s2
    populate_s2(s2_boards, sel);

    // If the family selector changes...
    $s1.change(function() {
      // Get a list of boards from the <option> tag's "boards" property
      var boards = $s1.find('option:selected')[0].boards;
      // Repopulate the board selector with the new list of boards.
      populate_s2(boards, sel);
    });

    // For the other one, send the new board name in a message
    // and the new name will be applied to Configuration.h (eventually)
    $s2.change(function() {
      msg({ command:'board', name:$(this).val() });
    });
  }

  // Send a message to the controller (abm.js:handleMessageFromUI)
  function msg(m) {
    if (m.command == 'tool') abm_tool(m.tool); // Show the tool before alerting the controller
    if (m.command == 'pane') abm_pane(m.pane); // Show the pane before alerting the controller
    //if (m.command == 'boards') abm_boards(m.data, m.selected); // Rebuild the board selectors and select the active one
    vscode.postMessage(m);
  }

// ]]>
</script>
<script src="${ js_path('jquery-3.6.0.min.js') }"></script>
<script src="${ js_path('abmview.js') }"></script>
<link nonce="${nonce}" rel="stylesheet" href="${ css_path('abmview.css') }" type="text/css" media="all" />
</head>
<body>
<div id="abm-layout">
<div id="abm-toolbar">
  <a id="abm-icon" onclick="msg({ command:'refresh' })"><img src="${ img_path('abm-tools-70.png') }" width="32" /></a>
  <button id="btn-build" type="button" onclick="msg({ command:'tool', tool:'build' })"><img src="${ img_path('tool-build.svg') }" /><span>Build</span></button>
  <button id="btn-config" type="button" onclick="msg({ command:'tool', tool:'config' })"><img src="${ img_path('tool-config.svg') }" /><span>Configure</span></button>
</div>
<div id="abm-build" class="abm-tool">
  <div id="abm-top">
    <button type="button" onclick="msg({ command:'monitor' })"><img src="${ img_path('btn-monitor.svg') }" /> Monitor</button>
    <button type="button" onclick="msg({ command:'refresh' })"><img src="${ img_path('btn-refresh.svg') }" /> Refresh</button>
  </div>
  <h1><a href="https://marlinfw.org">Marlin Firmware</a> <span>Auto Build <span id="abm-vers">${abm_version}</span></span></h1>
  <div id="error"></div>
  <div id="abm-main">
    <form id="showy">
      <label><input type="checkbox" value="1" name="show_on_startup" ${ check(prefs.show_on_startup()) }/>Show on Startup</label>
      <label><input type="checkbox" value="0" name="silent_build" ${ check(prefs.silent_build()) }/>Silent Build</label>
      <label><input type="checkbox" value="1" name="auto_reveal" ${ check(prefs.auto_reveal()) }/>Auto Reveal Build</label>
    </form>
    <table id="info">
      <tr><th>Firmware:</th>      <td><div>Marlin <span id="info-vers"></span></div><div id="info-date" class="abm-caption"></div></td></tr>
      <tr><th>Config By:</th>     <td><span id="info-auth"></span></td></tr>
      <tr><th>Machine Name:</th>  <td><div id="info-machine"></div><div id="info-machine-desc" class="abm-caption"></div></td></tr>
      <tr><th>Extruders:</th>     <td><div id="info-extruders"></div><div id="info-extruder-desc" class="abm-caption"></div></td></tr>
      <tr><th>Board:</th>         <td><div id="info-board"></div><div id="info-board-desc" class="abm-caption"></div></td></tr>
      <tr><th>Pins File:</th>     <td><div id="info-pins"></div><div id="info-pins-desc" class="abm-caption"></div></td></tr>
      <tr><th>Architectures:</th> <td><div id="info-archs"></div></td></tr>
      <tr><th>Environments:</th>  <td id="info-envs"></td></tr>
    </table>
    <div id="env-rows-src"><table>
      <tr>
        <td class="env-name"></td>
        <td>
          <button type="button" onclick="msg({ command:'pio', env:'<env>', cmd:'build' })" title="PIO Build"><img src="${ img_path('btn-build.svg') }" /> Build</button>
          <button class="upload" type="button" onclick="msg({ command:'pio', env:'<env>', cmd:'upload' })" title="PIO Upload"><img src="${ img_path('btn-upload.svg') }" /> Upload</button>
          <button class="debug" type="button" onclick="msg({ command:'pio', env:'<env>', cmd:'traceback' })" title="PIO Upload (Debug)"><img src="${ img_path('btn-debug.svg') }" /> Debug</button>
          <button class="clean" type="button" onclick="msg({ command:'pio', env:'<env>', cmd:'clean' })" title="PIO Clean"><img src="${ img_path('btn-clean.svg') }" /> Clean</button>
          <button class="clean purge" type="button" onclick="msg({ command:'pio', env:'<env>', cmd:'purge' })" title="Purge build folder"><img src="${ img_path('btn-clean.svg') }" /> Purge</button>
          <button class="run" type="button" onclick="msg({ command:'pio', env:'<env>', cmd:'run' })" title="Run">▷ Run</button>
          <span class="progress"></span>
        </td>
      </tr>
      <tr><td colspan="2" class="abm-caption env-more"><span></span></td></tr>
    </table></div>
    <div id="debug-text"><pre class="hilightable config"></pre></div>
  </div>
</div>
<div id="abm-config" class="abm-tool">
  <h1><a href="https://marlinfw.org">Marlin Firmware</a> <span>Configuration Tool</span></h1>
  <div class="subtabs">
    <button ref="board">Board</button> <button ref="geometry">Geometry</button> <button ref="lcd">LCD</button> <button ref="sd">SD</button> <button ref="more">More...</button>
  </div>
  <div class="subpanes">
    ${panes.board}
    ${panes.geometry}
    ${panes.lcd}
    ${panes.sd}
  </div>
</div>
<div id="abm-sidebar">
  <div id="abm-social">
    <a href="https://marlinfw.org/"><img src="${ img_path('abm-tools-32.png') }" /><span>Marlin Home</span></a>
    <a href="https://github.com/MarlinFirmware/Marlin"><img src="${ img_path('social-gh.svg') }" /><span>Marlin on GitHub</span></a>
    <a href="https://twitter.com/MarlinFirmware"><img src="${ img_path('social-tw.svg') }" /><span>@MarlinFirmware</span></a>
    <a href="https://www.facebook.com/groups/1049718498464482/"><img src="${ img_path('social-fb.svg') }" /><span>Marlin on Facebook</span></a>
    <a href="https://www.youtube.com/c/MarlinFirmware"><img src="${ img_path('social-yt.svg') }" /><span>Marlin on YouTube</span></a>
  </div>
</div>
<div id="abm-footer"><span>&copy; 2019-2024 MarlinFirmware</span></div>
</div>
</body>
</html>
